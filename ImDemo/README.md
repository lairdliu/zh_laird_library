# iov_sdk_linux_im
本文档为车信项目车机端消息能力sdk及demo的版本更新记录。

## src目录内容介绍
IM能力SDK代码，内含：
- j6p交叉编译环境配置脚本：[chexin_j6p_cross_env.sh]
- j6交叉编译环境配置脚本：[chexin_j6_cross_env.sh]
- x86编译脚本：[chexin_x86_ubuntu_env.sh]
- j6p Make文件：[Makefile_j6p_cross]
- j6 Make文件：[Makefile_j6_cross]
- x86 Make文件：[Makefile_x86_ubuntu]
- 单元测编译脚本：[Makefile](./src/Makefile.sh)
- 发布内容说明：interface/, target/, thirdparty/, demo/及README.md是发布时对外提供的内容。
- 依赖库版本说明：grpc-1.14.2, protobuf-3.5.1

## 配置信息
- appkey: 201904cx
- appkeypassword: 123456

## 安装依赖库
### 虚拟机
- uuid：apt-get install uuid-dev
- sqlite3：apt-get install sqlite3 libsqlite3-dev
- jsoncpp：sudo apt-get install libjsoncpp-dev
- curl：下载源码安装
- 其他：把grpc_x86.tar放到/usr/local/lib下解压；

### 车机
- 把grpc_arm.tar放到车机/usr/lib目录下解压；
- 开发环境下把所有车机所需的库放到编译环境可识别的LD_LIBRARY_PATH下，车机已有的库可从车机上拉取，或找斑马提供；

## 更新说明
### 20190228 v1.0.0
1. 提供车端消息能力SDK（虚拟机版）；
2. 具备账号相关功能和好友相关功能；
3. 提供了demo;

### 20190301 v1.0.1
1. 修改了Demo无法编译的问题；
2. 补充了所需的第三方依赖库；
3. 压缩了libcmhiim.so；

### 20190302 v1.0.2
1. 增加了获取voip接入地址接口；
2. 增加了车端消息能力SDK（车机版）；
3. 增加了车机端运行所需的lib库；

### 20190304 v1.0.3
1. 修复了获取好友列表问题；
2. 补充了车机端编译告警的lib库（不影响运行）；

### 20190311 v1.1.0
1. 修复删除好友不成功问题；
2. 增加了发送单聊消息、删除所有聊天消息接口；
3. 测试语音消息时，需使用预置的amr文件；

### 20190314 v1.1.1

1. 增加单聊消息功能，可接收文本、语音、已读回执、自定义通知等，可发送语音、已读回执；

2. 增加获取最近联系人、设置语音播放状态、删除所有消息等功能；

### 20190315 v1.1.2
1. 在语音消息结构体中增加文字内容；
2. 增加发送已读回执接口；

### 20190317 V1.1.3
1. 收到消息流程，增加设置FROM和修改写数据库操作:
2. 增加文件句柄为NULL的处理:

### 20190317 V1.1.4
1. 修复多端登录下，某端收不到消息情况；
2. 修复发送消息不稳定情况；

### 20190321 V1.2.0
1. 增加自定义消息插入数据库接口；
2. 增加设置好友免打扰的接口；
3. 增加获取所有消息占用空间接口；
4. 增加清除所有消息、多媒体文件接口；
5. 增加好友管理主叫侧抄送处理；
6. 增加收到对端消息撤回通知的处理；
7. 增加收到自己手机端发送消息的抄送通知处理；
8. 车机端做智能指针的优化处理；

### 20190328 V1.2.1
1. FriendInfo 增加三个字段：用户是否注册、昵称全拼、备注名全拼；
2. 修改ContactObserverBase的OnFiendChanged拼写错误，friend 少了个：

### 20190404 V1.3.0
1. 提供不带重采样的pcm/amr互转接口；
2. 修改车机SDK数据库存储文件结构，修改为按照用户名保存；

### 20190409 V1.3.1
1、好友列表展示好友手机号；
2、增加未处理好友请求的已读未读状态的接口；增加发起好友请求的时间戳字段；
3、点对点聊天—平台增加通话取消原因并提示给车信用户；
4、网络异常情况下的重连机制；

### 20190410 V1.3.2
1、增加账号登录增加被踢原因接口；
2、增加接受手机端实时推送备注名更新功能；
3、增加好友列表按首字母排序功能；
4、增加手机端添加转短备注名，同步更新设置至车机端；
5、增加本地消息记录删除，清空登录前一天00:00之前历史消息记录功能；
6、新增通过单条信息Msg id获取整条消息结构体接口；
7、新增新增显示会话的最后一条消息内容功能；
8、增加PCM重采样接口；

### 20190410 V1.3.3
1、解决从Request表项中读取request_time 时间戳时时间翻转的问题：

### 20190411 V1.3.4
1、解决request数据库status字段无法更新问题

### 20190411 V1.3.5
1、支持车获取机端好友列是否曾经是好友

### 20190416 V1.3.6
1、按照要求修改amr/pcm编解码接口，包括增加cancel能力、修改回调函数注册方式；
2、发送消息流程车机SDK增加保存语音信息处理；

### 20190423 V1.3.7
1、解决第一登录无法获取最近联系人的问题；
## 20190423 V1.3.8
1、解决第一登录无法获取最近联系人的问题；

### 2019424 V1.3.9
1、增加好友列表获取通知
2、自定义消息存入数据库时，发送时间字段赋值
3、解决备注名未插入数据库问题

### 2019425 V1.3.10
1、解决guid填充引起平台无法返回数据问题

### 2019425 V1.3.11
1、解决车机不支持的消息类型上报给业务SDK

### 2019425 V1.3.12
1、提供j6p版本的lib，包括grpc、amr、libcmhiim_cross_j6p

### 2019428 V1.5.0
1、解决车机端显示已经删除的好友问题
2、修改分页显示接口
3、修改kNtfMessageFriendListGet为kNtfMessageFriendListReady
4、支持设置单条消息已读

### 2019429 V1.5.1
1、车机从平台第一次同步消息携带携带GUID
2、提高PCM转AMR的音质
3、解决车机端显示已经删除的好友

### 2019429 V1.5.2
1、解决修改备注，添加好友，显示多条请求问题

### 2019429 V1.5.3
1、解决同端互踢，状态码返回错误问题

### 20190509 V1.5.4
1. 修改好友免打扰状态，不允许设置0值，也不返回0值
2. 增加获取未读消息接口
3. 调整车机端生成msg id的方式

### 20190509 V1.5.5
1、对外提供msgId生成接口
2、增加location消息的处理
3、好友邀请联动处理，主动处理（已读、同意、拒绝）好友请求时，将来自同一人的好友请求设置为相同状态
4、车机登录时，需获取离线接收的一键接人等自定义消息
5、增加getfriendinfo和getmsg 返回字段


### 20190509 V1.5.6
1、解决location消息body未赋值

### 20190513 V1.5.6
1、解决location消息body未赋值

### 20190515 V1.5.7
1、修改AMR<->PCM之间转换问题

### 20190509 V1.5.8
1、增加FREIND_MSG消息，处理好友第一条消息“你们已经成为好友开始聊天吧”

### 20190509 V1.5.9
1. 解决车机登陆后收不到第一条消息
2、解决send接口发送location消息，消息类型判断出错问题
3、增加location消息发送测试用例

### 20190516 V1.5.10
1. 解决车机登陆后收不到第一条消息
2、解决send接口发送location消息，消息类型判断出错问题
3、增加location消息发送测试代码

### 20190521 V1.5.10
1、修改语音消息和位置消息local path的获取方式

### 20190523 V1.5.11
1、增加删除会话接口
2、解决location消息未写入数据库问题
3、获取消息的时间顺序(历史消息未排序)
4、获取云端未读消息时会获取本地自定义消息

### 20190527 V1.5.12
1、更换云端服务器访问地址

### 20190527 V1.5.13
1、解决location构造函数filename未赋值，引起send接口coredump问题

### 20190531 V1.5.14
1、解决收到消息没有from_nick_name问题，对应任务单：AS28

### 20190606 V1.5.15
1、解决location消息因特殊字符无法插入数据库问题
2、解决locating消息发送时字段缺少问题
3、收到消息，回调消息from和to字段不正确问题，解决该问题修改了数据库名字，修改为testv2.db
4、新加好友，获取最近联系人为NULL的问题
5、发一条语音消息，车机端出现两条的问题

### 20190610 V1.5.16
1、解决body base64编码后，get和se有些t操作不配对，取出的body为base64编码后的值

### 20190614 V1.5.17
1、解决location消息接收时消息部分丢失, 导致消息解释异常。
2、解决重复login没有向业务发登陆成功通知的问题。


### 20190617 V1.5.18
1. 解决执行login  logout login操作后车机和平台断连的问题
2. 完善车机收到消息后去重的流程
3. 修改连续login后车机和平台断连的问题(当前没有绝对解决,有低概率失败的可能)

### 20190619 V1.5.19
1. 增加好友状态，修改前只有0（非好友）、1（好友）两个状态，修改后有0、1、2、3、4状态。需要智行、斑马一同适配修改。
   0：异常状态 1：两端互为好友 2：两方都不是好友 3：本端主动解除好友 4：对端解除好友
2. 修改get_friends_list接口函数入参，详细见接口文档。

### 20190621 V1.5.20
1. MessageWrapper添加发送时间默认初始化
2. location消息增加poi_id字段处理。
3. 修改使用时间戳来同步好友信令。
4. 根据好友信令产生好友删除，好友请求拒绝，好友请求同意通知回调。

### 20190624 V1.5.20
1、增加根据deviceID判断是否车机剔除自己，若deviceID相同，则不剔除。

### 20190627 V1.5.21
1、发送消息增加判断是否是好友，如果不是返回kFriendIsNotFriend。
2、修改设置消息已读接口，将指定会话所有消息设置为已读的处理方式修改为将指定会话的指定MSG ID及之前的消息设置为已读。
3、修改接口文档，完善各接口error返回值信息。

### 20190627 V1.5.21
1、发送消息增加判断是否是好友，如果不是返回kFriendIsNotFriend。
2、修改设置消息已读接口，将指定会话所有消息设置为已读的处理方式修改为将指定会话的指定MSG ID及之前的消息设置为已读。
3、修改接口文档，完善各接口error返回值信息。

### 20190704 V1.5.25
1、解决最近联系人获取不到自定义消息问题
2、解决接收消息插入数据库失败问题

### 20190707 V1.5.26
1、增加判断网络异常后重试连接流程。
2、网络异常后，减少发送消息的等待时间。

### 20190708 V1.5.27
1、解决车机上login出现segmefault问题

### 20190710 V1.5.28
1、调整发给业务的消息顺序。
2、调整GRPC的发送超时时间为7秒。

### 20190713 V1.5.29
1、修改数据库消息的时间精确度，由秒修改为毫秒。
2、修改获取好友信息流程，头像信息从平台实时获取。
3、增加获取未读消息的调试信息。

### 20190717 V1.5.30
1、解决登录车信，进入通讯录，发送消息给车友，返回对话列表，车友头像和名称显示错误的问题，对应斑马BUG单：VCHAT-176 VCHAT-177 

### 20190729 V1.5.31
1、更新平台proto文件
2、get_friend_user_info接口，如果查找好友失败，enable字段设置为2

### 20190802 V1.5.32
1、调整断连重试的触发策略。
2、断连重试期间，不会清除数据库数据。

### 20190807 V1.5.33
1、获取最近联系人接口增加返回信息。
2、解决退出再登录卡住的问题。